<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion des points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#c62828" />

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- Icône pour l'écran d'accueil -->
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    body { margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #333; color: #fff; padding: 10px 12px; display: flex; align-items: center; gap: 8px; }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    main { padding: 10px; }
    button { cursor: pointer; }
    .hidden { display: none; }
    .class-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
    .class-list li { margin-bottom: 8px; }
    .class-button { width: 100%; text-align: left; padding: 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; font-size: 16px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; }
    input[type="text"], input[type="number"] { width: 100%; box-sizing: border-box; padding: 6px; margin-bottom: 8px; }
    .btn-primary { background: #c62828; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; font-size: 15px; }
    .btn-secondary { background: #e0e0e0; border: none; padding: 6px 10px; border-radius: 4px; font-size: 14px; }
    .class-menu-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .students-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
    .student-card { position: relative; background: #ffffff; border-radius: 8px; border: 1px solid #ccc; height: 70px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .student-zone { position: absolute; top: 0; bottom: 0; width: 50%; }
    .student-zone.minus { left: 0; background: #ffebee; }
    .student-zone.plus { right: 0; background: #e8f5e9; }
    .student-label { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; text-align: center; padding: 4px; }
    .student-name { font-size: 14px; font-weight: 600; }
    .student-points { font-size: 13px; margin-top: 2px; opacity: 0.8; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 14px; text-align: center; }
    th { background: #f0f0f0; }
    td.name-cell { text-align: left; }
    .info { font-size: 13px; color: #555; margin-top: 4px; }
  </style>
</head>
<body>
<header>
  <button id="backButton" class="btn-secondary hidden">← Retour</button>
  <h1 id="headerTitle">Points élèves</h1>
</header>

<main>
  <section id="homeView">
    <h2>Choisir une classe</h2>
    <ul id="classList" class="class-list"></ul>

    <h3>Ajouter une classe</h3>
    <label>Nom de la classe :</label>
    <input type="text" id="classNameInput" placeholder="6e A, 5e B, 3e4..." />
    <label>Liste des élèves (un par ligne) :</label>
    <textarea id="studentsInput" placeholder="Élève 1
Élève 2
Élève 3"></textarea>
    <button id="createClassBtn" class="btn-primary">Créer la classe</button>
  </section>

  <section id="classMenuView" class="hidden">
    <h2 id="classMenuTitle"></h2>
    <div class="class-menu-buttons">
      <button id="openPointsView" class="btn-primary">Page pour gérer les points</button>
      <button id="openGradesView" class="btn-primary">Page des notes /20</button>
    </div>
  </section>

  <section id="pointsView" class="hidden">
    <p class="info">
      Partie <strong>gauche</strong> : +1 point, partie <strong>droite</strong> : −1 point.
    </p>
    <div id="studentsGrid" class="students-grid"></div>
  </section>

  <section id="gradesView" class="hidden">
    <label>Points max pour 20/20 :</label>
    <input type="number" id="maxPointsInput" value="20" min="1" />
    <p class="info">Note = 20 × points / points max (arrondi au dixième).</p>
    <table>
      <thead>
        <tr><th>Élève</th><th>Points</th><th>Note /20</th></tr>
      </thead>
      <tbody id="gradesTableBody"></tbody>
    </table>
  </section>
</main>

<script>
  const STORAGE_KEY = 'points_classes_v1';
  let appData = { classes: [], currentClassId: null, maxPoints: 20 };

  function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { try { appData = JSON.parse(saved); } catch(e) {} }
  }
  function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
  function getCurrentClass() { return appData.classes.find(c => c.id === appData.currentClassId) || null; }

  const homeView = document.getElementById('homeView');
  const classMenuView = document.getElementById('classMenuView');
  const pointsView = document.getElementById('pointsView');
  const gradesView = document.getElementById('gradesView');
  const headerTitle = document.getElementById('headerTitle');
  const backButton = document.getElementById('backButton');

  function showView(view) {
    homeView.classList.add('hidden');
    classMenuView.classList.add('hidden');
    pointsView.classList.add('hidden');
    gradesView.classList.add('hidden');
    backButton.classList.remove('hidden');

    if (view === 'home') {
      homeView.classList.remove('hidden');
      headerTitle.textContent = 'Points élèves';
      backButton.classList.add('hidden');
    } else if (view === 'classMenu') {
      classMenuView.classList.remove('hidden');
      const c = getCurrentClass();
      headerTitle.textContent = c ? c.name : 'Classe';
    } else if (view === 'points') {
      pointsView.classList.remove('hidden');
      const c = getCurrentClass();
      headerTitle.textContent = c ? c.name + ' – Points' : 'Points';
    } else if (view === 'grades') {
      gradesView.classList.remove('hidden');
      const c = getCurrentClass();
      headerTitle.textContent = c ? c.name + ' – Notes /20' : 'Notes /20';
    }
  }

  backButton.addEventListener('click', () => {
    if (!appData.currentClassId) { showView('home'); return; }
    const isPoints = !pointsView.classList.contains('hidden');
    const isGrades = !gradesView.classList.contains('hidden');
    if (isPoints || isGrades) showView('classMenu');
    else { appData.currentClassId = null; saveData(); renderHome(); showView('home'); }
  });

  const classListEl = document.getElementById('classList');
  const classNameInput = document.getElementById('classNameInput');
  const studentsInput = document.getElementById('studentsInput');
  const createClassBtn = document.getElementById('createClassBtn');
  const classMenuTitle = document.getElementById('classMenuTitle');

  function renderHome() {
    classListEl.innerHTML = '';
    if (appData.classes.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'Aucune classe pour le moment.';
      classListEl.appendChild(li);
      return;
    }
    appData.classes.forEach(c => {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.className = 'class-button';
      btn.textContent = c.name;
      btn.onclick = () => { appData.currentClassId = c.id; saveData(); renderClassMenu(); showView('classMenu'); };
      li.appendChild(btn);
      classListEl.appendChild(li);
    });
  }

  createClassBtn.addEventListener('click', () => {
    const name = classNameInput.value.trim();
    const lines = studentsInput.value.split('\n').map(l => l.trim()).filter(l => l);
    if (!name || !lines.length) { alert('Nom de classe ou élèves manquants.'); return; }
    const id = 'c_' + Date.now() + '_' + Math.floor(Math.random()*10000);
    const newClass = { id, name, students: lines.map(n => ({ name: n, points: 0 })) };
    appData.classes.push(newClass);
    appData.currentClassId = id;
    saveData();
    classNameInput.value = ''; studentsInput.value = '';
    renderHome(); renderClassMenu(); showView('classMenu');
  });

  const openPointsViewBtn = document.getElementById('openPointsView');
  const openGradesViewBtn = document.getElementById('openGradesView');

  function renderClassMenu() {
    const c = getCurrentClass();
    if (c) classMenuTitle.textContent = 'Classe : ' + c.name;
  }

  openPointsViewBtn.onclick = () => { renderPointsView(); showView('points'); };
  openGradesViewBtn.onclick = () => { renderGradesView(); showView('grades'); };

  const studentsGrid = document.getElementById('studentsGrid');

  function renderPointsView() {
    const c = getCurrentClass(); if (!c) return;
    studentsGrid.innerHTML = '';
    c.students.forEach((s, index) => {
      const card = document.createElement('div');
      card.className = 'student-card';

      const zoneMinus = document.createElement('div');
      zoneMinus.className = 'student-zone minus';
      zoneMinus.dataset.index = index;
      zoneMinus.dataset.action = 'minus';

      const zonePlus = document.createElement('div');
      zonePlus.className = 'student-zone plus';
      zonePlus.dataset.index = index;
      zonePlus.dataset.action = 'plus';

      const label = document.createElement('div');
      label.className = 'student-label';
      label.innerHTML = `<div class="student-name">${s.name}</div>
                         <div class="student-points">${s.points} pt${Math.abs(s.points) > 1 ? 's' : ''}</div>`;
      card.append(zoneMinus, zonePlus, label);
      studentsGrid.appendChild(card);
    });
  }

  studentsGrid.addEventListener('click', e => {
    const action = e.target.dataset.action;
    const index = e.target.dataset.index;
    const c = getCurrentClass();
    if (!c || index === undefined) return;
    if (action === 'plus') c.students[index].points++;
    if (action === 'minus') c.students[index].points--;
    saveData(); renderPointsView();
  });

  const maxPointsInput = document.getElementById('maxPointsInput');
  const gradesTableBody = document.getElementById('gradesTableBody');

  function computeGrade(points) {
    const max = appData.maxPoints || 1;
    const raw = 20 * points / max;
    const capped = Math.max(0, Math.min(20, raw));
    return Math.round(capped * 10) / 10;
  }

  function renderGradesView() {
    const c = getCurrentClass(); if (!c) return;
    maxPointsInput.value = appData.maxPoints;
    gradesTableBody.innerHTML = '';
    c.students.forEach(s => {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.className='name-cell'; tdName.textContent = s.name;
      const tdPoints = document.createElement('td'); tdPoints.textContent = s.points;
      const tdGrade = document.createElement('td'); const g = computeGrade(s.points); tdGrade.textContent = g.toFixed(1).replace('.', ',');
      tr.append(tdName, tdPoints, tdGrade);
      gradesTableBody.appendChild(tr);
    });
  }

  maxPointsInput.addEventListener('input', () => {
    let v = parseFloat(maxPointsInput.value); if (isNaN(v) || v <= 0) v = 1;
    appData.maxPoints = v; saveData(); renderGradesView();
  });

  // Enregistrement du service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }

  window.addEventListener('load', () => {
    loadData(); renderHome();
    if (appData.currentClassId && getCurrentClass()) { renderClassMenu(); showView('classMenu'); }
    else showView('home');
  });
</script>
</body>
</html>
